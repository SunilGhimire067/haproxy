global
    log         127.0.0.1 local2

    chroot      /var/lib/haproxy
    pidfile     /var/run/haproxy.pid
    maxconn     50000
    maxpipes    2500
    user        haproxy
    group       haproxy
    daemon
    tune.ssl.default-dh-param  2048

    tune.ssl.lifetime  3600
    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats

#---------------------------------------------------------------------
# common defaults that all the 'listen' and 'backend' sections will
# use if not designated in their block
#---------------------------------------------------------------------
defaults
    mode                    http
    log                     global
    option                  httplog
    option                  dontlognull
    option http-server-close
    option forwardfor       except 127.0.0.0/8
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           1m
    timeout connect         10s
    timeout client          1m
    timeout server          1m
    timeout http-keep-alive 10s
    timeout check           10s
    maxconn                 10000
stats refresh 5s
        stats hide-version
        stats uri     /admin
        stats realm   Haproxy\ Statistics
        stats auth    admin:pass


##################################Added By sunil For Stat 20241231#################


listen stats
    bind *:8081          # Listen on port 8080 for the stats page
    mode http            # HTTP mode for the stats page
    stats enable         # Enable the stats page
    stats uri /admin     # URI for the stats page
    stats refresh 5s     # Refresh interval for stats page
    stats hide-version   # Hide HAProxy version for security
    stats realm Haproxy\ Statistics
    stats auth admin:pass  # Basic authentication (change username:password)
    option httplog
    log /dev/log local0
    log /dev/log local1 notice
##########################################################

listen default
#bind *:8080
#frontend mclient
bind *:8080

mode http
#reqadd X-Forwarded-Proto:\ http
http-request add-header X-Forwarded-Proto http
default_backend mclient

backend mclient
mode http
option forwardfor
#option httpchk GET /echo HTTP/1.0
#acl forwarded_proto hdr_cnt(X-Forwarded-Proto) eq 0
#acl forwarded_port hdr_cnt(X-Forwarded-Port) eq 0
    http-request set-header X-Client-IP %[src]
#    http-request add-header X-Forwarded-Port %[dst_port] if forwarded_port
#    http-request add-header X-Forwarded-Proto https if { ssl_fc } forwarded_proto
    #http-request set-header X-Forwarded-Port %[dst_port]
    #http-request add-header X-Forwarded-Proto https


    http-request set-header Host qr.fonepay.com
         #server node1 10.31.213.3:31550 cookie node13 check inter 2000
         server node1 10.31.213.3:80 cookie node13 check inter 2000
         #server mclient-01 10.19.222.13:8080 cookie mclient-01 check inter 2000
         #server mclient-02 10.19.222.33:8080 cookie mclient-02 check inter 2000


#----------------------------------qr.fonepay.com 443-------------------------
frontend qrfonepay
        bind *:443 ssl crt /etc/haproxy/certs/fonepay/fonepay.com.crt


        acl accountvalidation_api path_beg /v1/name/validate
        use_backend verification if accountvalidation_api
        acl mobilevalidation_api path_beg /verifier-middleware/fonepay/direct/inquiry
        use_backend verification if mobilevalidation_api

        http-request add-header X-Forwarded-Proto https if { ssl_fc }
        http-request set-header X-Forwarded-Port %[dst_port]
        #redirect scheme https if !{ ssl_fc }
        use_backend qrbackend if { ssl_fc_sni qr.fonepay.com } # content switching based on SNI
        use_backend qrbackend-esewa if { ssl_fc_sni qr-esewa.fonepay.com } # content switching based on SNI
        use_backend qrnpci if { ssl_fc_sni qr-middleware-npci.fonepay.com } # content switching based on SNI
        use_backend qrnpcinew if { ssl_fc_sni qr-switch-npci.fonepay.com } # content switching based on SNI
        use_backend qrncellmiddleware if { ssl_fc_sni qr-switch-middleware.fonepay.com } # content switching based on SNI

####################### added by sunil for gateway #######################################################

        use_backend gateway if  { ssl_fc_sni gateway.fonepay.com }
        use_backend external-gateway if { ssl_fc_sni external-gateway.fonepay.com }
        use_backend ir-merchantapi if { ssl_fc_sni merchantapi-ir.fonepay.com }
        use_backend bankswitch if  { ssl_fc_sni bankswitch.fonepay.com }
        use_backend bankswitch-api if  { ssl_fc_sni bankswitch-api.fonepay.com }
        use_backend issuerbankhub if { ssl_fc_sni issuerbankhub.fonepay.com }
        use_backend gatewayncell if { ssl_fc_sni gateway-temp.fonepay.com }
        use_backend datasync if { ssl_fc_sni bank-artemis-api.fonepay.com }
        use_backend qrncellmiddleware if { ssl_fc_sni external-gateway-new.fonepay.com }
        use_backend external-gateway-v2 if { ssl_fc_sni external-gateway-v2.fonepay.com }
        use_backend beta-creditcard if { ssl_fc_sni beta-internal-fonepay-credit-card-api.fonepay.com }

#######################################################################################



         #####added by Pravesh for testing EBL to New QR######

         use_backend qrbackend1 if { ssl_fc_sni qr1.fonepay.com }
         #use_backend verification if { ssl_fc_sni verification.fonepay.com }

backend qrbackend
        mode http
        balance leastconn
#        appsession JSESSIONID len 52 timeout 3h request-learn prefix
        cookie JSESSIONID prefix
        server node1 10.31.213.3:80 cookie node13 check inter 2000
        #server node13 10.19.222.13:8080 cookie node13 check inter 2000
        #server node33 10.19.222.33:8080 cookie node33 check inter 2000


backend qrbackend-esewa
        mode http
        balance leastconn
#        appsession JSESSIONID len 52 timeout 3h request-learn prefix
        cookie JSESSIONID prefix
        server node16 10.19.222.81:80 cookie node13 check inter 2000
        #server node13 10.19.222.13:8080 cookie node13 check inter 2000
        #server node33 10.19.222.33:8080 cookie node33 check inter 2000

backend qrnpci
        balance leastconn
#        appsession JSESSIONID len 52 timeout 3h request-learn prefix
        cookie JSESSIONID prefix
        server node14 10.31.213.3:80 cookie node15 check inter 2000
        #server node13 10.19.222.13:8080 cookie node13 check inter 2000
        #server node33 10.19.222.33:8080 cookie node33 check inter 2000


backend qrnpcinew
        balance leastconn
#        appsession JSESSIONID len 52 timeout 3h request-learn prefix
        cookie JSESSIONID prefix
        server node15 10.31.213.3:80 cookie node15 check inter 2000
        #server node13 10.19.222.13:8080 cookie node13 check inter 2000
        #server node33 10.19.222.33:8080 cookie node33 check inter 2000

backend qrncellmiddleware
        balance leastconn
        cookie JSESSIONID prefix
        server qrncell 10.71.217.21:80 cookie qrncell check inter 2000


############
backend qrbackend1
        mode http
        cookie JSESSIONID prefix
        balance leastconn
        server node1 10.31.213.3:80 cookie node13 check inter 2000
        #server node2 10.19.222.33:8080 cookie node33 check inter 2000
        #server node3 10.19.222.13:8080 cookie node13 check inter 2000


############
backend verification
        mode http
        cookie JSESSIONID prefix
        #server node1 10.19.222.61:80 cookie node13 check inter 2000



backend gateway
        mode http
        cookie JSESSIONID prefix
        #server node61 10.19.222.61:80 cookie node61 check inter 2000
        #server node62 10.19.222.62:80 cookie node62 check inter 2000
        #server node65 10.19.222.65:80 cookie node65 check inter 2000
        server node81 10.19.222.82:80 cookie node81 check inter 2000
        server node82 10.19.222.83:80 cookie node82 check inter 2000
        server node83 10.19.222.84:80 cookie node83 check inter 20001

backend external-gateway
        mode http
        cookie JSESSIONID prefix
        #server node61 10.19.222.61:80 cookie node61 check inter 2000
        #server node62 10.19.222.62:80 cookie node62 check inter 2000
        #server node65 10.19.222.65:80 cookie node65 check inter 2000
        server node82 10.19.222.82:80 cookie node82 check inter 2000
        server node83 10.19.222.83:80 cookie node83 check inter 2000
        server node84 10.19.222.84:80 cookie node84 check inter 2000


backend ir-merchantapi
        mode http
        cookie JSESSIONID prefix
        server node66 10.31.213.11:80 cookie node66 check inter 2000


backend bankswitch
        mode http
        cookie JSESSIONID prefix
#        server node67 10.19.222.61:80 cookie node67 check inter 2000
#        server node68 10.19.222.62:80 cookie node68 check inter 2000
#        server node69 10.19.222.65:80 cookie node69 check inter 2000
        server node82 10.19.222.82:80 cookie node82 check inter 2000
        server node83 10.19.222.83:80 cookie node83 check inter 2000
        server node84 10.19.222.84:80 cookie node84 check inter 2000

backend bankswitch-api
        mode http
        cookie JSESSIONID prefix
#        server node70 10.19.222.61:80 cookie node70 check inter 2000
#        server node71 10.19.222.62:80 cookie node71 check inter 2000
#        server node72 10.19.222.65:80 cookie node72 check inter 2000
        server node82 10.19.222.82:80 cookie node82 check inter 2000
        server node83 10.19.222.83:80 cookie node83 check inter 2000
        server node84 10.19.222.84:80 cookie node84 check inter 2000


backend issuerbankhub
        mode http
        cookie JSESSIONID prefix
        server node73 10.31.213.3:80 cookie node73 check inter 2000

backend gatewayncell
        mode http
        cookie JSESSIONID prefix
        server node74 10.19.222.82:80 cookie node74 check inter 2000

backend datasync
        mode http
        cookie JSESSIONID prefix
        server datasync-01 10.31.213.30:61616 cookie datasync-01 check inter 2000



backend external-gateway-v2
        mode http
        cookie JSESSIONID prefix
        #server node61 10.19.222.61:80 cookie node61 check inter 2000
        #server node62 10.19.222.62:80 cookie node62 check inter 2000
        #server node65 10.19.222.65:80 cookie node65 check inter 2000
        server node82 10.19.222.82:80 cookie node82 check inter 2000
        server node83 10.19.222.83:80 cookie node83 check inter 2000
        server node84 10.19.222.84:80 cookie node84 check inter 2000

backend beta-creditcard
        mode http
        cookie JSESSIONID prefix
        server node10 10.31.213.10:80 cookie node10 check inter 2000ÃŸ
